generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())

  recipients Recipient[]
  templates  Template[]
  orders     Order[]
  usage      UserUsage?
  events     Event[]

  // Stripe subscription fields
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // Return Address (Phase 2)
  returnName     String?
  returnAddress1 String?
  returnAddress2 String?
  returnCity     String?
  returnState    String?
  returnZip      String?
  returnCountry  String? @default("US")

  mailOrders MailOrder[]
}

model UserUsage {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  letterGenerations   Int @default(0)
  imageGenerations    Int @default(0)
  lettersSent         Int @default(0)
  voiceTranscriptions Int @default(0)
  imageAnalyses       Int @default(0)

  // Product-specific tracking (Phase 2)
  postcardsSent         Int @default(0)
  lettersSentStandard   Int @default(0)
  greetingCardsSent     Int @default(0)
  windowlessLettersSent Int @default(0)
  giftCardsSent         Int @default(0)

  // Cost tracking
  totalSpent Decimal @default(0) @db.Decimal(10, 2)

  tier    String   @default("FREE")
  resetAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Recipient {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  address1  String
  address2  String
  city      String
  state     String
  zip       String
  country   String   @default("US")
  createdAt DateTime @default(now())

  orders Order[]
}

model Template {
  id               String  @id @default(cuid())
  userId           String
  user             User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name             String
  frontImageUrl    String?
  message          String
  handwritingStyle String

  // AI generation fields
  aiGenerated      Boolean @default(false)
  generationPrompt String?
  tone             String?
  occasion         String?

  createdAt DateTime @default(now())

  orders Order[]
}

model Order {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipientId     String
  recipient       Recipient @relation(fields: [recipientId], references: [id])
  templateId      String?
  template        Template? @relation(fields: [templateId], references: [id])
  thanksIoOrderId String?
  status          String    @default("pending")
  scheduledFor    DateTime? // For scheduled sending (SL-109)
  createdAt       DateTime  @default(now())

  @@index([scheduledFor, status])
}

model MailOrder {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  thanksIoOrderId String @unique
  productType     String
  status          String @default("queued")

  recipientCount Int
  message        String @db.Text

  cost Decimal @db.Decimal(10, 2)

  scheduledFor DateTime? // For scheduled sending (SL-109)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([thanksIoOrderId])
  @@index([scheduledFor, status])
}

model Event {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventType String
  metadata  Json     @default("{}")
  timestamp DateTime @default(now())

  @@index([userId, eventType])
  @@index([timestamp])
}

// ========================================
// GROWTH DATA PLANE (GDP)
// Unified customer data for analytics
// ========================================

// Canonical person record (combines anonymous + identified)
model Person {
  id String @id @default(cuid())

  // Core identity
  email     String? @unique
  phone     String?
  firstName String?
  lastName  String?

  // Computed traits
  activeDays    Int     @default(0)
  coreActions   Int     @default(0)
  lifetimeValue Decimal @default(0) @db.Decimal(10, 2)

  // Timestamps
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  identityLinks  IdentityLink[]
  unifiedEvents  UnifiedEvent[]
  emailMessages  EmailMessage[]
  subscriptions  PersonSubscription[]
  deals          Deal[]
  features       PersonFeatures?
  segmentMembers SegmentMember[]

  @@index([email])
  @@index([lastSeenAt])
}

// Links person to external system IDs
model IdentityLink {
  id       String @id @default(cuid())
  personId String
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  source     String // 'posthog', 'stripe', 'meta', 'user', 'anonymous'
  externalId String // The ID in that system

  createdAt DateTime @default(now())

  @@unique([source, externalId])
  @@index([personId])
}

// Unified events from all sources
model UnifiedEvent {
  id       String  @id @default(cuid())
  personId String?
  person   Person? @relation(fields: [personId], references: [id], onDelete: SetNull)

  // Event data
  eventName  String
  source     String // 'web', 'app', 'email', 'stripe', 'meta'
  properties Json   @default("{}")

  // Attribution
  sessionId   String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  // Timestamps
  timestamp DateTime @default(now())

  @@index([personId, eventName])
  @@index([timestamp])
  @@index([source])
}

// Email campaigns sent
model EmailMessage {
  id       String @id @default(cuid())
  personId String
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  // Email metadata
  resendId String @unique
  from     String
  to       String
  subject  String
  tags     Json   @default("[]") // Array of tags

  // Campaign tracking
  campaign  String?
  segmentId String?

  sentAt DateTime @default(now())

  // Relations
  emailEvents EmailEvent[]

  @@index([personId])
  @@index([campaign])
  @@index([sentAt])
}

// Email engagement events (delivered, opened, clicked, bounced)
model EmailEvent {
  id        String       @id @default(cuid())
  messageId String
  message   EmailMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  eventType String // 'delivered', 'opened', 'clicked', 'bounced', 'complained'

  // For clicks
  clickedUrl String?

  // Metadata
  userAgent String?
  ipAddress String?

  timestamp DateTime @default(now())

  @@index([messageId])
  @@index([eventType])
  @@index([timestamp])
}

// Subscription status snapshot
model PersonSubscription {
  id       String @id @default(cuid())
  personId String
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  // Stripe data
  stripeCustomerId     String
  stripeSubscriptionId String @unique
  stripePriceId        String

  // Status
  status String // 'active', 'canceled', 'past_due', 'trialing'
  plan   String // 'FREE', 'PRO', 'BUSINESS'
  mrr    Decimal @db.Decimal(10, 2)

  // Dates
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAt           DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([personId])
  @@index([status])
}

// Sales/revenue tracking
model Deal {
  id       String @id @default(cuid())
  personId String
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  dealType String // 'subscription', 'one_time', 'upsell'
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("USD")

  status String // 'open', 'won', 'lost'

  wonAt     DateTime?
  createdAt DateTime  @default(now())

  @@index([personId])
  @@index([status])
  @@index([wonAt])
}

// Computed person features for segmentation
model PersonFeatures {
  id       String @id @default(cuid())
  personId String @unique
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  // Behavioral features
  activeDays   Int @default(0)
  coreActions  Int @default(0)
  pricingViews Int @default(0)
  emailOpens   Int @default(0)
  emailClicks  Int @default(0)

  // Product-specific
  lettersCreated   Int @default(0)
  lettersSent      Int @default(0)
  templatesCreated Int @default(0)
  recipientsAdded  Int @default(0)

  // Time-based
  daysSinceSignup     Int @default(0)
  daysSinceLastActive Int @default(0)

  // Computed at
  computedAt DateTime @default(now())

  @@index([activeDays])
  @@index([daysSinceLastActive])
}

// Segment definitions
model Segment {
  id          String @id @default(cuid())
  name        String @unique
  description String

  // Segment rules (JSON query)
  rules Json

  // Automation
  enabled      Boolean @default(true)
  actionType   String? // 'email', 'meta_audience', 'webhook'
  actionConfig Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members SegmentMember[]

  @@index([name])
}

// Segment membership (for fast lookups)
model SegmentMember {
  id        String  @id @default(cuid())
  segmentId String
  segment   Segment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  personId  String
  person    Person  @relation(fields: [personId], references: [id], onDelete: Cascade)

  enteredAt DateTime  @default(now())
  exitedAt  DateTime?

  @@unique([segmentId, personId])
  @@index([personId])
  @@index([segmentId])
}
